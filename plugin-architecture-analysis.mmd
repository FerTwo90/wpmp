graph TB
    %% ARQUITECTURA DEL PLUGIN WP-MP-SUBSCRIPTIONS
    
    subgraph "üîß CORE PLUGIN"
        MAIN[wp-mp-subscriptions.php<br/>üìã Plugin Principal<br/>- Define constantes<br/>- Carga clases<br/>- Hooks b√°sicos]
        
        HELPERS[helpers.php<br/>üõ†Ô∏è Funciones Utilitarias<br/>- wpmps_get_access_token<br/>- wpmps_log_* functions<br/>- wpmps_collect_context]
        
        SETTINGS[settings.php<br/>‚öôÔ∏è Configuraci√≥n<br/>- P√°gina de ajustes<br/>- Token MP<br/>- Roles de usuario]
    end
    
    subgraph "üì° API & COMUNICACI√ìN"
        MPCLIENT[class-mp-client.php<br/>üåê Cliente MercadoPago<br/>- create_preapproval ‚ùå NO USADO<br/>- get_preapproval ‚úÖ FUNCIONA<br/>- search_preapproval_plans ‚ùå FALLA<br/>- search_preapprovals ‚úÖ FUNCIONA<br/>- search_payments ‚úÖ FUNCIONA]
        
        ROUTES[routes.php<br/>üõ£Ô∏è Endpoints REST<br/>- /wp-json/mp/v1/webhook ‚úÖ<br/>- /wp-json/mp/v1/webhook-test ‚úÖ<br/>- AJAX postmessage handlers ‚úÖ<br/>- template_redirect finalizaci√≥n ‚úÖ]
        
        WEBHOOK[üîî Webhook Handler<br/>wpmps_handle_webhook<br/>- Procesa notificaciones MP<br/>- Actualiza metadata usuario<br/>- Sincroniza roles<br/>- Logging completo]
    end
    
    subgraph "üíæ GESTI√ìN DE DATOS"
        SUBSCRIBERS[class-wpmps-subscribers.php<br/>üë• Gesti√≥n Suscriptores<br/>- get_subscribers_fast (OPTIMIZADO)<br/>- refresh_subscriber<br/>- Cach√© persistente + backup<br/>- cleanup_old_token_data<br/>‚ö†Ô∏è PROBLEMA: M√∫ltiples llamadas MP]
        
        PAYMENTS[class-wpmps-payments.php<br/>üí≥ Gesti√≥n Pagos<br/>- get_payments_with_mapping<br/>- Convierte preapprovals a pagos<br/>- Mapeo con suscriptores<br/>‚ö†Ô∏è PROBLEMA: API suscripciones inestable]
        
        SYNC[class-wpmps-sync.php<br/>üîÑ Sincronizaci√≥n<br/>- get_plans (LIMITADO)<br/>- search_preapproval_plans<br/>- Cach√© de planes<br/>‚ö†Ô∏è PROBLEMA: Endpoint planes no funciona]
    end
    
    subgraph "üéõÔ∏è PANEL ADMIN"
        ADMIN[class-wpmps-admin.php<br/>üè¢ Panel Administraci√≥n<br/>- Men√∫s y submen√∫s<br/>- Handlers de acciones<br/>- Renderizado de vistas]
        
        VIEWS[üìä Vistas Admin<br/>- settings.php<br/>- subscribers.php<br/>- payments.php<br/>- plans.php<br/>- logs.php]
        
        LOGS[class-wpmps-logs.php<br/>üìù Sistema de Logs<br/>- Ring buffer<br/>- Filtros por canal<br/>- Exportaci√≥n NDJSON]
    end
    
    subgraph "üé® FRONTEND"
        SHORTCODES[shortcodes.php<br/>üîó Shortcode [mp_subscribe]<br/>- Bot√≥n de suscripci√≥n<br/>- Redirecci√≥n a MP<br/>- Validaci√≥n de login]
        
        BLOCKS[üì¶ Gutenberg Block<br/>subscribe-button/<br/>- Bloque para editor<br/>- Configuraci√≥n visual]
    end
    
    subgraph "‚è∞ AUTOMATIZACI√ìN"
        CRON[class-wpmps-cron.php<br/>‚è∞ Tareas Programadas<br/>- check_subscriptions (cada 15min)<br/>- Sincronizaci√≥n roles<br/>- Rate limiting (10min entre checks)<br/>- Mantenimiento cach√©<br/>‚úÖ FUNCIONA BIEN]
        
        LOGGER[class-wpmps-logger.php<br/>üìä Sistema de Logging<br/>- Ring buffer (500 eventos)<br/>- Canales: AUTH, WEBHOOK, ADMIN, etc<br/>- Debug autom√°tico<br/>- Exportaci√≥n NDJSON<br/>‚úÖ FUNCIONA BIEN]
    end
    
    subgraph "üåê MERCADOPAGO API"
        MPAPI[üè¶ MercadoPago API<br/>- /preapproval_plan ‚ùå NO FUNCIONA<br/>- /preapproval/{id} ‚úÖ FUNCIONA<br/>- /preapproval/search ‚úÖ FUNCIONA<br/>- /v1/payments/search ‚úÖ FUNCIONA<br/>‚ö†Ô∏è PROBLEMA: Inconsistencias API]
        
        MPCHECKOUT[üíª MP Checkout Web<br/>subscriptions/checkout<br/>- Interfaz de usuario ‚úÖ<br/>- Procesamiento de pago ‚úÖ<br/>- Webhooks autom√°ticos ‚úÖ<br/>- PostMessage ‚ö†Ô∏è INTERMITENTE]
    end
    
    subgraph "üíæ WORDPRESS DATA"
        WPUSERS[üë§ WP Users<br/>- user_email<br/>- user_roles<br/>- user_meta]
        
        USERMETA[üìã User Meta<br/>- _suscripcion_activa<br/>- _mp_preapproval_id<br/>- _mp_plan_id<br/>- _mp_updated_at]
        
        OPTIONS[‚öôÔ∏è WP Options<br/>- wpmps_access_token<br/>- wpmps_plans_cache<br/>- wpmps_log_ring]
    end
    
    %% FLUJO PRINCIPAL DE SUSCRIPCI√ìN
    MAIN --> SHORTCODES
    SHORTCODES --> MPCHECKOUT
    MPCHECKOUT --> WEBHOOK
    WEBHOOK --> MPCLIENT
    MPCLIENT --> MPAPI
    WEBHOOK --> USERMETA
    WEBHOOK --> WPUSERS
    
    %% FLUJO DE ADMINISTRACI√ìN
    ADMIN --> VIEWS
    ADMIN --> SUBSCRIBERS
    ADMIN --> PAYMENTS
    ADMIN --> SYNC
    SUBSCRIBERS --> MPCLIENT
    PAYMENTS --> MPCLIENT
    SYNC --> MPCLIENT
    
    %% FLUJO DE DATOS
    SUBSCRIBERS --> WPUSERS
    SUBSCRIBERS --> USERMETA
    PAYMENTS --> MPAPI
    SYNC --> OPTIONS
    
    %% LOGGING
    WEBHOOK --> LOGGER
    MPCLIENT --> LOGGER
    ADMIN --> LOGGER
    LOGGER --> OPTIONS
    
    %% CACH√â Y PERFORMANCE
    CRON --> SUBSCRIBERS
    CRON --> PAYMENTS
    CRON --> OPTIONS
    
    %% CONFIGURACI√ìN
    SETTINGS --> OPTIONS
    HELPERS --> OPTIONS
    
    subgraph "üö® PROBLEMAS IDENTIFICADOS"
        PROB1[‚ùå API Planes MP<br/>search_preapproval_plans<br/>NO FUNCIONA<br/>Endpoint inestable]
        
        PROB2[‚ö†Ô∏è M√∫ltiples llamadas MP<br/>get_subscribers_fast<br/>Puede hacer 50+ requests<br/>Necesita optimizaci√≥n]
        
        PROB3[‚ö†Ô∏è Cach√© inconsistente<br/>Datos desactualizados<br/>Entre transients y user_meta<br/>Limpieza manual necesaria]
        
        PROB4[‚ö†Ô∏è PostMessage intermitente<br/>Comunicaci√≥n modal-parent<br/>Fallback a traditional flow<br/>Funciona pero no siempre]
    end
    
    %% CONEXIONES DE PROBLEMAS
    SYNC --> PROB1
    SUBSCRIBERS --> PROB2
    SUBSCRIBERS --> PROB3
    MPCHECKOUT --> PROB4
    
    %% ESTILOS
    classDef coreClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef apiClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef dataClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef adminClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef frontendClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef automationClass fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef mpClass fill:#ffebee,stroke:#b71c1c,stroke-width:2px
    classDef wpClass fill:#e3f2fd,stroke:#0d47a1,stroke-width:2px
    classDef problemClass fill:#ffcdd2,stroke:#d32f2f,stroke-width:3px
    
    class MAIN,HELPERS,SETTINGS coreClass
    class MPCLIENT,ROUTES,WEBHOOK apiClass
    class SUBSCRIBERS,PAYMENTS,SYNC dataClass
    class ADMIN,VIEWS,LOGS adminClass
    class SHORTCODES,BLOCKS frontendClass
    class CRON,LOGGER automationClass
    class MPAPI,MPCHECKOUT mpClass
    class WPUSERS,USERMETA,OPTIONS wpClass
    class PROB1,PROB2,PROB3,PROB4 problemClass
%
% ========================================
%% AN√ÅLISIS DE ARQUITECTURA - RESUMEN
%% ========================================
%% 
%% COMPONENTES QUE FUNCIONAN BIEN:
%% ‚úÖ Sistema de logging (WPMPS_Logger)
%% ‚úÖ Cliente MP b√°sico (get_preapproval)
%% ‚úÖ Webhooks de notificaci√≥n
%% ‚úÖ Cron de sincronizaci√≥n
%% ‚úÖ Panel de administraci√≥n
%% ‚úÖ Shortcodes y botones
%% 
%% PROBLEMAS PRINCIPALES:
%% ‚ùå API de planes MP (search_preapproval_plans) - ENDPOINT ROTO
%% ‚ö†Ô∏è M√∫ltiples llamadas MP en get_subscribers - INEFICIENTE
%% ‚ö†Ô∏è Sistema de cach√© inconsistente - DATOS DESACTUALIZADOS
%% ‚ö†Ô∏è PostMessage intermitente - FUNCIONA PERO NO SIEMPRE
%% 
%% FLUJO PRINCIPAL FUNCIONAL:
%% 1. Usuario hace clic en [mp_subscribe] ‚Üí Redirecci√≥n a MP
%% 2. Usuario completa pago en MP ‚Üí Webhook notifica
%% 3. Webhook actualiza user_meta ‚Üí Sincroniza roles
%% 4. Cron mantiene sincronizaci√≥n ‚Üí Sistema funciona
%% 
%% RECOMENDACIONES:
%% 1. Deshabilitar temporalmente la p√°gina de Planes (API rota)
%% 2. Optimizar get_subscribers_fast (limitar llamadas MP)
%% 3. Unificar sistema de cach√© (solo transients o solo user_meta)
%% 4. Mantener fallback tradicional para PostMessage
%%
%% ARQUITECTURA GENERAL: S√ìLIDA Y FUNCIONAL
%% El plugin tiene una base s√≥lida con separaci√≥n clara de responsabilidades.
%% Los problemas son espec√≠ficos y no afectan la funcionalidad core.