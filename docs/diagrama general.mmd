flowchart TD
  %% Nodos base
  subgraph WP["WordPress"]
    A1["Admin: Ajustes<br/>Token + Plan por defecto"]
    A2["Admin: Sincronizar Planes"]
    A3["Admin: Generador de Botón<br/>(shortcode/bloque)"]
    A4["Admin: Suscriptores<br/>(lista + CSV + refresh)"]
    A5["Admin: Logs de Webhooks<br/>(últimos 50 + reprocesar)"]
    U1["Usuario logueado<br/>Página con shortcode/bloque"]
    S1["Servidor WP: Acción create<br/>(nonce + plan_id/amount)"]
    W1["REST: /wp-json/mp/v1/webhook"]
    M1["(user_meta)<br/>_suscripcion_activa<br/>_mp_preapproval_id<br/>_mp_plan_id"]
  end
  subgraph MP["Mercado Pago"]
    P1["(Planes<br/>preapproval_plan_id)"]
    C1{"Checkout<br/>Preapproval"}
    API["API MP"]
  end
  %% Flujos de administración
  A2 -->|"admin-post wpmps_sync_plans"| API
  API -->|"planes (search)"| A2
  A5 <-->|consulta evento / reprocesar| API
  %% Generación de botón / inserción
  A3 -->|elige plan/label/back| A3SC["Genera shortcode"]
  A3SC -->|copiar/insertar| U1
  %% Flujo de usuario
  U1 -->|click botón| S1
  S1 -->|"POST /preapproval<br/>back_url + payer_email + (plan_id o monto)"| API
  API -->|init_point| S1
  S1 -->|redirect| C1
  C1 -->|autoriza| API
  C1 -->|cancela/falla| API
  %% Webhook y mapeo de acceso
  API -->|POST webhook<br/>id o data.id| W1
  W1 -->|"GET /preapproval/{id}<br/>(revalidar estado)"| API
  W1 -->|set yes/no + ids| M1
  M1 --> A4
  M1 --> URES["Back URL del sitio<br/>muestra resultado"]
  %% Opcional rol
  M1 -->|"authorized → asigna rol<br/>otro → quita rol"| R1["Rol suscriptor_premium"]
  %% Notas
  classDef note fill:#eef,stroke:#99c,color:#333;
  N1(["Seguridad: HTTPS, nonce, token sólo server,<br/>Idempotency-Key, sanitización, sin PII"]):::note
  N2(["Cache: planes via transient 20min"]):::note
  N3(["Logs: último 50 webhooks en opción"]):::note
  A1 --- N1
  A2 --- N2
  W1 --- N3
